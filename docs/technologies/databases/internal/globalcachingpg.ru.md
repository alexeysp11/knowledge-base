# Глабальное кэширование в PostgreSQL

Реализация изолирования данных для таблиц в БД для конкретного пользователя.

## Описание подхода

Допустим, в крупной базе данных очень часто используются временные таблицы для хранения разных типов, например:

```SQL
CREATE TABLE tmp_id1 (
  id1 NUMBER
);
CREATE TABLE tmp_id2 (
  id1 NUMBER,
  id2 NUMBER
);
CREATE TABLE tmp_id3 (
  id1 NUMBER,
  id2 NUMBER,
  id3 NUMBER
);
CREATE TABLE tmp_id_datetime (
  id1 NUMBER,
  date TIMESTAMP
);
```

При этом, эти таблицы существуют для всех пользователей, имеющих доступ к БД. Но данные, хранящиеся в этих таблицах, всегда были изолированы для каждого пользователя (т.е. пользователь А не мог увидеть данные в таблице `tmp_id1`, которые могли быть видны для пользователя Б).
Данные в таблицах оставались в таблице и после того, как заканчивалась транзакция.

В Oracle для реализации подобного изолирования данных для конкретного пользователя используются временные таблицы, создаваемые в рамках сессии пользователя. Эти таблицы доступны только для конкретного пользователя и удаляются после завершения сессии. При этом данные в этих таблицах остаются после завершения транзакции.

Основное преимущество данного подхода к кэшированию данных внутри БД заключается в ускорении доступа к данным за счет уменьшения нагрузки на сеть и сервер при обращении к БД. Кроме того, это позволяет более эффективно использовать ресурсы БД, так как данные могут быть кэшированы внутри БД и не загружаться с диска каждый раз при обращении к ним.

## Реализация в PostgreSQL

### Временные таблицы, доступные для конкретной сессии пользователя

**Сессия в БД** - это период времени, в течение которого пользователь подключен к БД и выполняет запросы. Сессия начинается с подключения к БД и заканчивается отключением.

Сессия в БД отличается от соединения тем, что соединение - это физическое подключение к БД, а сессия - это логическое соединение, которое устанавливается между пользователем и БД на основе соединения.

Сессия отличается от транзакции тем, что транзакция - это логически связанная группа операций с БД, которая может быть зафиксирована или отменена как единое целое. Сессия же - это период времени, в течение которого пользователь подключен к БД и выполняет запросы.

Соединение к БД отличается от транзакции тем, что соединение - это физическое подключение к БД, а транзакция - это логически связанная группа операций с БД.

В PostgreSQL также есть возможность создания временных таблиц, которые могут быть доступны только для конкретной сессии пользователя. Однако, по умолчанию данные в этих таблицах удаляются после завершения транзакции. Для того чтобы сохранить данные во временных таблицах после завершения транзакции, необходимо использовать ключевое слово `ON COMMIT` при создании таблицы. Например:

```SQL
CREATE TEMP TABLE tmp_id1 (
  id1 INTEGER
) ON COMMIT PRESERVE ROWS;
```

Если таблица создана с помощью команды `CREATE TEMP TABLE`, то она будет удалена после завершения сессии пользователя.

Команда `ON COMMIT PRESERVE ROWS` означает, что данные во временной таблице будут сохранены после завершения транзакции.

### Использование схем, доступных для конкретных пользователей или групп пользователей

Также в PostgreSQL есть возможность использования схем, которые могут быть доступны только для конкретных пользователей или групп пользователей. В этом случае можно создать отдельную схему для каждого пользователя, в которой будут храниться его данные. Однако, это требует более сложной настройки БД и может быть менее эффективно, чем использование временных таблиц.

В PostgreSQL для каждого пользователя можно создать отдельную схему. Ограничений на количество пользователей или групп пользователей, для которых будут выделены отдельные схемы, нет.

## Оценка подхода

Плюсы нового подхода к кэшированию данных: данные доступны для пользователя в любой момент, не зависимо от времени жизни сессии; возможность использовать индексы и другие оптимизации для ускорения доступа к данным. Минусы: увеличение размера БД из-за хранения дублирующихся данных; необходимость обновлять данные в кэше при изменении данных в основной таблице.

В PostgreSQL можно поставить ограничение на чтение определённых записей для пользователей (например, пользователь А видит одни только свои данные, пользователь Б видит только свои, а админ БД видит данные всех пользователей). Для этого можно использовать механизмы **RBAC (Role-Based Access Control)** для установки ограничений на чтение определенных записей для пользователей. Например, можно создать отдельную роль для каждого пользователя или группы пользователей и установить ограничения на чтение данных для этой роли.
