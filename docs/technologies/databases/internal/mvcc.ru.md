# mvcc 

**MVCC** (англ. Multi-Version Concurrency Control) - это механизм контроля конкурентности, который используется в PostgreSQL для обеспечения параллельного доступа к данным из разных транзакций. Он основан на создании нескольких версий данных вместо блокировки строк.

Роль MVCC в PostgreSQL заключается в том, что он позволяет транзакциям читать данные без блокировки и изменять данные в изолированных версиях, что повышает параллельность запросов и уменьшает конфликты блокировок.

Преимущества использования MVCC включают увеличение параллельности запросов, уменьшение конфликтов блокировок, повышение производительности системы, обеспечение изоляции транзакций и предотвращение deadlock'ов. 
Связь между MVCC и уровнями изоляции транзакций в PostgreSQL заключается в том, что MVCC позволяет обеспечить изоляцию транзакций на разных уровнях (*Read Uncommitted*, *Read Committed*, *Repeatable Read*, *Serializable*) без блокировок.

## Реализация

Компоненты PostgreSQL, отвечающие за реализацию MVCC, включают в себя механизмы хранения версий данных (WAL - Write-Ahead Logging) и механизмы управления транзакциями.

Разница между MVCC и блокировками заключается в том, что MVCC создает несколько версий данных для каждой транзакции, позволяя им читать и изменять данные параллельно, в то время как блокировки требуют эксклюзивного доступа к данным.

### Версионирование

В PostgreSQL версионирование строк данных с помощью MVCC происходит путем создания новой версии строки при каждом изменении данных. Старая версия сохраняется для чтения другими транзакциями.

Для получения представления о версиях строки данных в PostgreSQL можно использовать системные каталоги `pg_catalog` или специальные функции для работы с версиями данных.

Длительность хранения версий данных в PostgreSQL при использовании MVCC контролируется с помощью процесса `VACUUM` и настройками параметров базы данных, такими как `autovacuum_vacuum_scale_factor` и `autovacuum_vacuum_threshold`.

Операции транзакций, которые могут повлиять на версионирование данных при использовании MVCC, включают операции `INSERT`, `UPDATE` и `DELETE`, которые создают новые версии строк или помечают старые версии как удаленные.

Механизм очистки устаревших версий данных в PostgreSQL с использованием MVCC осуществляется автоматически с помощью процесса `VACUUM`, который удаляет неактуальные версии строк и освобождает пространство.

## Потенциальные проблемы

Проблема фантомного чтения возникает, когда одна транзакция видит изменения в данных, которые были выполнены другой транзакцией после начала первой транзакции. MVCC помогает решить эту проблему путем предоставления изолированных версий данных для каждой транзакции.

Использование MVCC может привести к утечкам памяти в PostgreSQL, если не правильно настроены параметры `VACUUM` или если процессы очистки не работают должным образом. Для избежания утечек памяти необходимо правильно настроить параметры `VACUUM` и следить за процессами очистки.

## Рекомендации

В PostgreSQL нельзя отключить MVCC, так как он является основным механизмом контроля конкурентности в системе. Отключение MVCC приведет к серьезным проблемам с изоляцией транзакций и целостностью данных.

Рекомендации по оптимизации работы с MVCC включают правильную настройку параметров `VACUUM`, использование индексов для ускорения доступа к данным, разумное использование длинных транзакций, мониторинг процессов очистки и регулярное обслуживание базы данных.
