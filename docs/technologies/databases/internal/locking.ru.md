# locking

**Блокировкой** называется механизм, который предотвращает одновременное изменение одних и тех же данных несколькими транзакциями. Блокировки в базах данных чаще всего возникают во время обновления записей или операций, для которых не был выполнен `commit`.

Блокировка таблицы в PostgreSQL предотвращает другие транзакции от выполнения операций записи или чтения на этой таблице. Блокировка строки в PostgreSQL предотвращает другие транзакции от изменения или чтения определенной строки в таблице.

## Виды блокировок

В PostgreSQL поддерживаются различные виды блокировок, такие как `SHARE`, `ROW SHARE`, `ROW EXCLUSIVE`, `SHARE UPDATE EXCLUSIVE`, `EXCLUSIVE` и другие.

- `SHARE` блокировка позволяет другим транзакциям читать данные, но не позволяет им изменять данные. 
- `EXCLUSIVE` блокировка предотвращает другие транзакции от чтения или изменения данных.

Отличие между `NOWAIT` и `WAIT` блокировками в PostgreSQL заключается в том, что `NOWAIT` пытается получить блокировку без ожидания, а `WAIT` будет ждать до момента получения блокировки.

## Блокировка таблицы

Основное различие между блокировкой таблицы и блокировкой строки заключается в том, что блокировка таблицы предотвращает доступ ко всем данным в таблице, в то время как блокировка строки применяется только к конкретной строке данных.

Операции, которые могут вызвать блокировку всей таблицы в PostgreSQL, включают операции `ALTER TABLE`, `TRUNCATE TABLE`, `VACUUM FULL` и другие операции, которые требуют эксклюзивного доступа к таблице.

Проблемы, которые могут возникнуть при длительной блокировке таблицы в PostgreSQL, включают задержки в доступе к данным для других пользователей, возможные deadlock'ы и ухудшение производительности системы.

Для избежания блокировки таблицы при одновременном выполнении операций чтения и записи можно использовать уровни изоляции транзакций, оптимизировать запросы, использовать индексы и разграничивать доступ к данным.

В PostgreSQL можно установить блокировку на несколько таблиц одновременно с помощью команды `LOCK TABLE`.

## Блокировка строк

В PostgreSQL можно установить блокировку на отдельные строки с помощью команды `SELECT ... FOR UPDATE` или использовать специальные типы блокировок для строк.

## Проблемы

### Deadlock

Deadlock - это ситуация, когда две или более транзакции блокируют друг друга, ожидая освобождения ресурсов, которые удерживают другие транзакции. Для предотвращения deadlock'ов в PostgreSQL можно использовать правильное управление транзакциями, избегать длинных транзакций и использовать стратегии обработки deadlock'ов.

### Конфликты блокировок

Для минимизации конфликтов блокировок при высокой нагрузке на базу данных можно использовать разделение данных, оптимизацию запросов, использование индексов, правильное управление транзакциями и мониторинг активных блокировок.

## Рекомендации

Рекомендации по использованию блокировок включают выбор наиболее подходящего уровня изоляции транзакций, оптимизацию запросов, избегание длинных транзакций, использование индексов и правильное управление конфликтами блокировок.

Определение активных блокировок:
- Для определения активных блокировок в PostgreSQL можно использовать системную функцию `pg_locks` или команду `pg_stat_activity`.
- Для проверки активных блокировок *для конкретной таблицы* в PostgreSQL можно использовать запрос к системным каталогам `pg_locks` и `pg_stat_activity` с фильтрацией по имени таблицы.
